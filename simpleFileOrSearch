import os
import re
import openpyxl
from datetime import datetime

# ğŸ”¹ ê²€ìƒ‰ ì„¤ì •
SEARCH_DIR = r"D:\source"  # íƒìƒ‰í•  ë£¨íŠ¸ í´ë” ê²½ë¡œ
WORD_FILE = r"D:\keywords.txt"  # ê²€ìƒ‰ ë‹¨ì–´ ëª©ë¡ íŒŒì¼ (í•œ ì¤„ì— í•˜ë‚˜)
OUTPUT_FILE = r"D:\search_result.xlsx"  # ê²°ê³¼ ì €ì¥ íŒŒì¼ëª…
EXTENSIONS = ('.java', '.cs', '.xml')

# ğŸ”¹ ê²€ìƒ‰ ë‹¨ì–´ ë¡œë“œ
with open(WORD_FILE, 'r', encoding='utf-8') as f:
    words = [w.strip() for w in f.readlines() if w.strip()]

# ğŸ”¹ ì •ê·œí‘œí˜„ì‹ ì»´íŒŒì¼ (ì†ë„ í•µì‹¬)
# (['"])(ë‹¨ì–´1|ë‹¨ì–´2|ë‹¨ì–´3)\1 í˜•íƒœë¡œ ìƒì„±
pattern = re.compile(rf"(['\"])\b({'|'.join(map(re.escape, words))})\b\1")

# ğŸ”¹ ì—‘ì…€ ì¤€ë¹„
wb = openpyxl.Workbook()
ws = wb.active
ws.title = "SearchResult"
ws.append(["íŒŒì¼ ê²½ë¡œ", "ë¼ì¸ ë²ˆí˜¸", "ë§¤ì¹­ ë¬¸ìì—´"])

# ğŸ”¹ íƒìƒ‰ ë° ê²€ìƒ‰
file_count = 0
match_count = 0

for root, dirs, files in os.walk(SEARCH_DIR):
    for file in files:
        if file.lower().endswith(EXTENSIONS):
            file_count += 1
            file_path = os.path.join(root, file)

            try:
                with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                    for i, line in enumerate(f, 1):
                        # ë§¤ì¹­ ê²°ê³¼ ëª¨ë‘ ì°¾ê¸°
                        for m in pattern.finditer(line):
                            ws.append([file_path, i, m.group()])
                            match_count += 1
            except Exception as e:
                print(f"[ERROR] {file_path} - {e}")

# ğŸ”¹ ì €ì¥
ws.append([])
ws.append(["ê²€ìƒ‰ ì™„ë£Œ ì‹œê°", datetime.now().strftime("%Y-%m-%d %H:%M:%S")])
ws.append(["ì´ íŒŒì¼ ìˆ˜", file_count])
ws.append(["ì´ ë§¤ì¹­ ìˆ˜", match_count])

wb.save(OUTPUT_FILE)

print(f"âœ… ê²€ìƒ‰ ì™„ë£Œ! ê²°ê³¼: {OUTPUT_FILE}")
print(f"  - ì´ íŒŒì¼ ìˆ˜: {file_count}")
print(f"  - ë§¤ì¹­ ìˆ˜: {match_count}")
