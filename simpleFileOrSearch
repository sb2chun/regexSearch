import os
import re
import openpyxl
import threading
from datetime import datetime
from concurrent.futures import ThreadPoolExecutor, as_completed
import tkinter as tk
from tkinter import filedialog, messagebox

# =======================================
# ğŸ”¹ ê²€ìƒ‰ í•¨ìˆ˜ (ë©€í‹°ì½”ì–´)
# =======================================
def search_files(root_path, regex_str, ignore_case):
    EXTENSIONS = ('.java', '.cs', '.xml')
    MAX_WORKERS = os.cpu_count() or 8

    try:
        flags = re.IGNORECASE if ignore_case else 0
        pattern = re.compile(regex_str, flags)
    except re.error as e:
        messagebox.showerror("ì •ê·œì‹ ì˜¤ë¥˜", f"ìœ íš¨í•˜ì§€ ì•Šì€ ì •ê·œí‘œí˜„ì‹ì…ë‹ˆë‹¤.\n\n{str(e)}")
        return

    wb = openpyxl.Workbook()
    ws = wb.active
    ws.title = "SearchResult"
    ws.append(["íŒŒì¼ëª…", "ê²€ìƒ‰í‚¤ì›Œë“œ", "ë¼ì¸", "ë‚´ìš©", "ì „ì²´ê²½ë¡œ"])

    # ëª¨ë“  íŒŒì¼ ìˆ˜ì§‘
    all_files = []
    for root, _, files in os.walk(root_path):
        for file in files:
            if file.lower().endswith(EXTENSIONS):
                all_files.append(os.path.join(root, file))

    if not all_files:
        messagebox.showinfo("ê²°ê³¼ ì—†ìŒ", "íƒìƒ‰í•  ëŒ€ìƒ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        return

    # íŒŒì¼ë³„ ê²€ìƒ‰
    def search_file(file_path):
        results = []
        file_name = os.path.basename(file_path)
        try:
            with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                for i, line in enumerate(f, 1):
                    for m in pattern.finditer(line):
                        matched = m.group()
                        results.append((file_name, matched, i, line.strip(), file_path))
        except Exception as e:
            print(f"[ERROR] {file_path}: {e}")
        return results

    match_count = 0

    # ë©€í‹°ì½”ì–´ ê²€ìƒ‰ ì‹¤í–‰
    with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
        futures = {executor.submit(search_file, f): f for f in all_files}
        for future in as_completed(futures):
            try:
                results = future.result()
                for r in results:
                    ws.append(r)
                match_count += len(results)
            except Exception as e:
                print(f"[ERROR] {futures[future]}: {e}")

    # ê²°ê³¼ íŒŒì¼ ì €ì¥
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    output_path = os.path.join(root_path, f"search_result_{timestamp}.xlsx")
    ws.append([])
    ws.append(["ì´ íŒŒì¼ ìˆ˜", len(all_files)])
    ws.append(["ë§¤ì¹­ëœ í•­ëª© ìˆ˜", match_count])
    ws.append(["ì™„ë£Œ ì‹œê°„", datetime.now().strftime("%Y-%m-%d %H:%M:%S")])
    wb.save(output_path)

    messagebox.showinfo(
        "ê²€ìƒ‰ ì™„ë£Œ",
        f"ì´ íŒŒì¼ ìˆ˜: {len(all_files)}\në§¤ì¹­ ìˆ˜: {match_count}\n\nê²°ê³¼ íŒŒì¼:\n{output_path}"
    )

# =======================================
# ğŸ”¹ UI ì´ë²¤íŠ¸
# =======================================
def browse_directory():
    folder = filedialog.askdirectory()
    if folder:
        entry_path.delete(0, tk.END)
        entry_path.insert(0, folder)

def start_search():
    root_path = entry_path.get().strip()
    regex_str = entry_regex.get().strip()
    ignore_case = var_ignore.get()

    if not root_path or not os.path.exists(root_path):
        messagebox.showerror("ì˜¤ë¥˜", "ìœ íš¨í•œ í´ë” ê²½ë¡œë¥¼ ì„ íƒí•˜ì„¸ìš”.")
        return
    if not regex_str:
        messagebox.showerror("ì˜¤ë¥˜", "ì •ê·œí‘œí˜„ì‹ì„ ì…ë ¥í•˜ì„¸ìš”.")
        return

    threading.Thread(
        target=search_files, args=(root_path, regex_str, ignore_case), daemon=True
    ).start()

# =======================================
# ğŸ”¹ Tkinter GUI
# =======================================
root = tk.Tk()
root.title("ì •ê·œí‘œí˜„ì‹ ê¸°ë°˜ í•˜ë“œì½”ë”© ê²€ìƒ‰ê¸° (ë©€í‹°ì½”ì–´)")
root.geometry("620x300")
root.resizable(False, False)

tk.Label(root, text="ğŸ“‚ íƒìƒ‰ ê²½ë¡œ:", anchor="w").pack(fill="x", padx=10, pady=(15, 0))
frame_path = tk.Frame(root)
frame_path.pack(fill="x", padx=10)
entry_path = tk.Entry(frame_path)
entry_path.pack(side="left", fill="x", expand=True, padx=(0, 5))
tk.Button(frame_path, text="í´ë” ì„ íƒ", command=browse_directory).pack(side="right")

tk.Label(root, text="ğŸ§© ì •ê·œí‘œí˜„ì‹ ì…ë ¥:", anchor="w").pack(fill="x", padx=10, pady=(15, 0))
entry_regex = tk.Entry(root)
entry_regex.pack(fill="x", padx=10, pady=(0, 5))
entry_regex.insert(0, r"(['\"])(operator|system|config)\1")  # ì˜ˆì‹œ

var_ignore = tk.BooleanVar(value=False)
tk.Checkbutton(root, text="ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ê²€ìƒ‰", variable=var_ignore).pack(anchor="w", padx=15, pady=5)

tk.Button(
    root, text="ğŸ” ê²€ìƒ‰ ì‹œì‘", command=start_search, bg="#0078D7", fg="white", height=2
).pack(fill="x", padx=10, pady=(10, 0))

tk.Label(root, text="â€» ê²€ìƒ‰ í™•ì¥ì: .java, .cs, .xml", fg="gray").pack(pady=5)

root.mainloop()
