import os
import re
import tkinter as tk
from tkinter import ttk, filedialog, messagebox
import pandas as pd
from datetime import datetime

# ---------------------------
# ì •ê·œì‹ ë¶„í•  ì»´íŒŒì¼ í•¨ìˆ˜
# ---------------------------
def compile_large_regex(pattern_text, chunk_size=500):
    # '|'ë¡œ êµ¬ë¶„ëœ í‚¤ì›Œë“œê°€ ë„ˆë¬´ ë§ì„ ë•Œ ë¶„í• 
    parts = pattern_text.split('|')
    regexes = []
    for i in range(0, len(parts), chunk_size):
        chunk = '|'.join(parts[i:i + chunk_size])
        try:
            regexes.append(re.compile(chunk))
        except re.error as e:
            print(f"âš  ì •ê·œì‹ ì˜¤ë¥˜ (chunk {i//chunk_size}): {e}")
    return regexes


# ---------------------------
# íŒŒì¼ ë‚´ í…ìŠ¤íŠ¸ ê²€ìƒ‰ í•¨ìˆ˜
# ---------------------------
def search_files():
    search_path = path_entry.get()
    pattern_text = regex_entry.get().strip()
    extension = ext_entry.get().strip()

    if not search_path or not pattern_text:
        messagebox.showwarning("ê²½ê³ ", "ê²½ë¡œì™€ ì •ê·œí‘œí˜„ì‹ì„ ì…ë ¥í•˜ì„¸ìš”.")
        return

    result_list.delete(*result_list.get_children())
    results.clear()

    # ì •ê·œì‹ ë¶„í•  ì»´íŒŒì¼
    regexes = compile_large_regex(pattern_text)
    print(f"âœ… ì •ê·œì‹ {len(regexes)}ê°œë¡œ ë¶„í•  ì»´íŒŒì¼ ì™„ë£Œ")

    matched_files = []
    for root, _, files in os.walk(search_path):
        for file in files:
            if not extension or file.endswith(extension):
                matched_files.append(os.path.join(root, file))

    print(f"ğŸ” ì´ {len(matched_files)}ê°œ íŒŒì¼ ê²€ìƒ‰ ì¤‘...")

    for full_path in matched_files:
        try:
            with open(full_path, encoding='utf-8', errors='ignore') as f:
                for i, line in enumerate(f, 1):
                    for regex in regexes:
                        match = regex.search(line)
                        if match:
                            # ì–´ë–¤ í‚¤ì›Œë“œê°€ ë§¤ì¹­ë˜ì—ˆëŠ”ì§€ ì¶”ì¶œ
                            keyword = match.group(0)
                            result = (
                                os.path.basename(full_path),
                                i,
                                keyword,
                                line.strip(),
                                full_path
                            )
                            results.append(result)
                            result_list.insert('', 'end', values=result)
                            break  # í•œ ì¤„ì—ì„œ í•˜ë‚˜ë§Œ ë§¤ì¹­ë˜ë©´ ë‹¤ìŒ ì¤„ë¡œ
        except Exception as e:
            print(f"âš  íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: {full_path}: {e}")

    messagebox.showinfo("ì™„ë£Œ", f"ê²€ìƒ‰ ì™„ë£Œ ({len(results)}ê±´)")


# ---------------------------
# ì—‘ì…€ ì €ì¥ í•¨ìˆ˜
# ---------------------------
def save_to_excel():
    if not results:
        messagebox.showwarning("ê²½ê³ ", "ì €ì¥í•  ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return

    df = pd.DataFrame(results, columns=['íŒŒì¼ëª…', 'ë¼ì¸', 'í‚¤ì›Œë“œ', 'ë‚´ìš©', 'ì „ì²´ê²½ë¡œ'])
    file_path = filedialog.asksaveasfilename(
        defaultextension=".xlsx",
        filetypes=[("Excel íŒŒì¼", "*.xlsx")]
    )
    if file_path:
        df.to_excel(file_path, index=False)
        messagebox.showinfo("ì™„ë£Œ", f"ì—‘ì…€ ì €ì¥ ì™„ë£Œ: {file_path}")


# ---------------------------
# GUI êµ¬ì„±
# ---------------------------
root = tk.Tk()
root.title("ì •ê·œí‘œí˜„ì‹ ëŒ€ìš©ëŸ‰ ê²€ìƒ‰ê¸°")
root.geometry("1100x600")

frame = ttk.Frame(root, padding=10)
frame.pack(fill='x')

# ê²½ë¡œ ì„ íƒ
ttk.Label(frame, text="ê²€ìƒ‰ ê²½ë¡œ:").grid(row=0, column=0, sticky='w')
path_entry = ttk.Entry(frame, width=80)
path_entry.grid(row=0, column=1, padx=5)
ttk.Button(frame, text="ì°¾ê¸°", command=lambda: path_entry.insert(0, filedialog.askdirectory())).grid(row=0, column=2)

# í™•ì¥ì
ttk.Label(frame, text="í™•ì¥ì(.java ë“±):").grid(row=1, column=0, sticky='w')
ext_entry = ttk.Entry(frame, width=15)
ext_entry.grid(row=1, column=1, sticky='w', padx=5)

# ì •ê·œí‘œí˜„ì‹ ì…ë ¥
ttk.Label(frame, text="ì •ê·œí‘œí˜„ì‹:").grid(row=2, column=0, sticky='nw')
regex_entry = tk.Text(frame, width=80, height=5)
regex_entry.grid(row=2, column=1, padx=5, pady=5)

# ë²„íŠ¼
btn_frame = ttk.Frame(frame)
btn_frame.grid(row=3, column=1, pady=5, sticky='e')
ttk.Button(btn_frame, text="ê²€ìƒ‰", command=search_files).grid(row=0, column=0, padx=5)
ttk.Button(btn_frame, text="ì—‘ì…€ ì €ì¥", command=save_to_excel).grid(row=0, column=1, padx=5)

# ê²°ê³¼ í‘œì‹œ
cols = ('íŒŒì¼ëª…', 'ë¼ì¸', 'í‚¤ì›Œë“œ', 'ë‚´ìš©', 'ì „ì²´ê²½ë¡œ')
result_list = ttk.Treeview(root, columns=cols, show='headings', height=20)
for col in cols:
    result_list.heading(col, text=col)
    result_list.column(col, width=150 if col != 'ë‚´ìš©' else 400)
result_list.pack(fill='both', expand=True)

results = []

root.mainloop()
