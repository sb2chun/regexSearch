import os
import re
import openpyxl
from datetime import datetime
from concurrent.futures import ThreadPoolExecutor, as_completed

# ==========================
# ğŸ”§ ì‚¬ìš©ì ì…ë ¥
# ==========================
SEARCH_DIR = input("ğŸ“‚ íƒìƒ‰í•  í´ë” ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”: ").strip()
if not os.path.exists(SEARCH_DIR):
    print("âŒ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    exit()

regex_str = input("ğŸ” ê²€ìƒ‰í•  ì •ê·œí‘œí˜„ì‹ì„ ì…ë ¥í•˜ì„¸ìš”: ").strip()
if not regex_str:
    print("âŒ ì •ê·œí‘œí˜„ì‹ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")
    exit()

ignore_case_input = input("ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ê²€ìƒ‰í• ê¹Œìš”? (Y/N): ").strip().lower()
IGNORE_CASE = ignore_case_input == 'y'

# í™•ì¥ì ë° ìŠ¤ë ˆë“œ ì„¤ì •
EXTENSIONS = ('.java', '.cs', '.xml')
MAX_WORKERS = os.cpu_count() or 8  # ìë™ìœ¼ë¡œ CPU ì½”ì–´ ìˆ˜ì— ë§ê²Œ

# ==========================
# ğŸ”§ ì •ê·œì‹ ì»´íŒŒì¼
# ==========================
try:
    flags = re.IGNORECASE if IGNORE_CASE else 0
    pattern = re.compile(regex_str, flags)
    print(f"âœ… ì •ê·œì‹ ì»´íŒŒì¼ ì™„ë£Œ: {regex_str}")
except re.error as e:
    print(f"âŒ ì •ê·œì‹ ì˜¤ë¥˜: {e}")
    exit()

# ==========================
# ğŸ”§ ì—‘ì…€ ì´ˆê¸°í™”
# ==========================
wb = openpyxl.Workbook()
ws = wb.active
ws.title = "SearchResult"
ws.append(["íŒŒì¼ ê²½ë¡œ", "ë¼ì¸ ë²ˆí˜¸", "ë§¤ì¹­ ë¬¸ìì—´"])

# ==========================
# ğŸ”§ íŒŒì¼ í•˜ë‚˜ ê²€ìƒ‰ í•¨ìˆ˜
# ==========================
def search_file(file_path):
    results = []
    try:
        with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
            for i, line in enumerate(f, 1):
                for m in pattern.finditer(line):
                    results.append((file_path, i, m.group()))
    except Exception as e:
        print(f"[ERROR] {file_path}: {e}")
    return results

# ==========================
# ğŸ”§ ëŒ€ìƒ íŒŒì¼ ìˆ˜ì§‘
# ==========================
all_files = []
for root, _, files in os.walk(SEARCH_DIR):
    for file in files:
        if file.lower().endswith(EXTENSIONS):
            all_files.append(os.path.join(root, file))

print(f"\nğŸ” ì´ ëŒ€ìƒ íŒŒì¼ ìˆ˜: {len(all_files)}ê°œ")
if not all_files:
    print("âŒ íƒìƒ‰í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
    exit()

# ==========================
# ğŸ”§ ë³‘ë ¬ ê²€ìƒ‰ ì‹œì‘
# ==========================
match_count = 0
file_count = len(all_files)

with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
    futures = {executor.submit(search_file, fp): fp for fp in all_files}
    for i, future in enumerate(as_completed(futures), 1):
        file_path = futures[future]
        try:
            results = future.result()
            for r in results:
                ws.append(r)
            match_count += len(results)
        except Exception as e:
            print(f"[ERROR] {file_path}: {e}")

        if i % 100 == 0:
            print(f"  â–¶ ì§„í–‰ë¥ : {i}/{file_count} íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ...")

# ==========================
# ğŸ”§ ê²°ê³¼ ì €ì¥
# ==========================
timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
OUTPUT_FILE = os.path.join(SEARCH_DIR, f"search_result_{timestamp}.xlsx")

ws.append([])
ws.append(["ê²€ìƒ‰ ì™„ë£Œ ì‹œê°", datetime.now().strftime("%Y-%m-%d %H:%M:%S")])
ws.append(["ì´ íŒŒì¼ ìˆ˜", file_count])
ws.append(["ì´ ë§¤ì¹­ ìˆ˜", match_count])

wb.save(OUTPUT_FILE)

print("\nâœ… ê²€ìƒ‰ ì™„ë£Œ!")
print(f"ğŸ“ ê²°ê³¼ íŒŒì¼: {OUTPUT_FILE}")
print(f"ğŸ“„ ì´ íŒŒì¼ ìˆ˜: {file_count}")
print(f"ğŸ” ë§¤ì¹­ ìˆ˜: {match_count}")
