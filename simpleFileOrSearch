import os
import re
import openpyxl
import threading
from datetime import datetime
from concurrent.futures import ThreadPoolExecutor, as_completed
import tkinter as tk
from tkinter import filedialog, messagebox, ttk

# =======================================
# ğŸ”¹ ê¸€ë¡œë²Œ ë³€ìˆ˜
# =======================================
search_results = []
stop_flag = False

# =======================================
# ğŸ”¹ ê²€ìƒ‰ í•¨ìˆ˜
# =======================================
def search_files(root_path, regex_str, ignore_case, tree, progress_var, btn_search, btn_stop):
    global search_results, stop_flag
    stop_flag = False
    search_results = []

    EXTENSIONS = ('.java', '.cs', '.xml')
    MAX_WORKERS = os.cpu_count() or 8

    try:
        flags = re.IGNORECASE if ignore_case else 0
        pattern = re.compile(regex_str, flags)
    except re.error as e:
        messagebox.showerror("ì •ê·œì‹ ì˜¤ë¥˜", f"ìœ íš¨í•˜ì§€ ì•Šì€ ì •ê·œí‘œí˜„ì‹ì…ë‹ˆë‹¤.\n\n{str(e)}")
        btn_search.config(state="normal")
        btn_stop.config(state="disabled")
        return

    # Tree ì´ˆê¸°í™”
    for row in tree.get_children():
        tree.delete(row)

    # íŒŒì¼ ìˆ˜ì§‘
    all_files = []
    for root, _, files in os.walk(root_path):
        for file in files:
            if file.lower().endswith(EXTENSIONS):
                all_files.append(os.path.join(root, file))

    if not all_files:
        messagebox.showinfo("ê²°ê³¼ ì—†ìŒ", "íƒìƒ‰í•  ëŒ€ìƒ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        btn_search.config(state="normal")
        btn_stop.config(state="disabled")
        return

    total_files = len(all_files)
    processed_files = 0

    def search_file(file_path):
        nonlocal processed_files
        results = []
        if stop_flag:
            return results
        file_name = os.path.basename(file_path)
        try:
            with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                for i, line in enumerate(f, 1):
                    for m in pattern.finditer(line):
                        results.append((file_name, m.group(), i, line.strip(), file_path))
        except Exception as e:
            print(f"[ERROR] {file_path}: {e}")
        finally:
            processed_files += 1
            progress_var.set(int(processed_files / total_files * 100))
        return results

    btn_search.config(state="disabled")
    btn_stop.config(state="normal")

    with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
        futures = {executor.submit(search_file, f): f for f in all_files}
        for future in as_completed(futures):
            if stop_flag:
                break
            try:
                results = future.result()
                for r in results:
                    tree.insert("", tk.END, values=r)
                    search_results.append(r)
            except Exception as e:
                print(f"[ERROR] {futures[future]}: {e}")

    btn_search.config(state="normal")
    btn_stop.config(state="disabled")
    if stop_flag:
        messagebox.showinfo("ê²€ìƒ‰ ì¤‘ë‹¨", f"ê²€ìƒ‰ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\në§¤ì¹­ëœ í•­ëª© ìˆ˜: {len(search_results)}")
    else:
        messagebox.showinfo("ê²€ìƒ‰ ì™„ë£Œ", f"ê²€ìƒ‰ ì™„ë£Œ!\nì´ ë§¤ì¹­ ìˆ˜: {len(search_results)}")
    progress_var.set(0)

# =======================================
# ğŸ”¹ ì¤‘ì§€ ë²„íŠ¼ í•¨ìˆ˜
# =======================================
def stop_search():
    global stop_flag
    stop_flag = True

# =======================================
# ğŸ”¹ ì—‘ì…€ ì €ì¥ í•¨ìˆ˜
# =======================================
def save_to_excel():
    if not search_results:
        messagebox.showwarning("ê²½ê³ ", "ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return
    folder = filedialog.askdirectory(title="ì—‘ì…€ ì €ì¥í•  í´ë” ì„ íƒ")
    if not folder:
        return

    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    output_path = os.path.join(folder, f"search_result_{timestamp}.xlsx")
    wb = openpyxl.Workbook()
    ws = wb.active
    ws.title = "SearchResult"
    ws.append(["íŒŒì¼ëª…", "ê²€ìƒ‰í‚¤ì›Œë“œ", "ë¼ì¸", "ë‚´ìš©", "ì „ì²´ê²½ë¡œ"])
    for r in search_results:
        ws.append(r)
    wb.save(output_path)
    messagebox.showinfo("ì €ì¥ ì™„ë£Œ", f"ì—‘ì…€ íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤:\n{output_path}")

# =======================================
# ğŸ”¹ UI ì´ë²¤íŠ¸
# =======================================
def browse_directory():
    folder = filedialog.askdirectory()
    if folder:
        entry_path.delete(0, tk.END)
        entry_path.insert(0, folder)

def start_search():
    root_path = entry_path.get().strip()
    regex_str = entry_regex.get().strip()
    ignore_case = var_ignore.get()

    if not root_path or not os.path.exists(root_path):
        messagebox.showerror("ì˜¤ë¥˜", "ìœ íš¨í•œ í´ë” ê²½ë¡œë¥¼ ì„ íƒí•˜ì„¸ìš”.")
        return
    if not regex_str:
        messagebox.showerror("ì˜¤ë¥˜", "ì •ê·œí‘œí˜„ì‹ì„ ì…ë ¥í•˜ì„¸ìš”.")
        return

    threading.Thread(
        target=search_files,
        args=(root_path, regex_str, ignore_case, tree, progress_var, btn_search, btn_stop),
        daemon=True
    ).start()

# =======================================
# ğŸ”¹ Tkinter UI
# =======================================
root = tk.Tk()
root.title("ì •ê·œí‘œí˜„ì‹ ê²€ìƒ‰ê¸° (ë©€í‹°ì½”ì–´ + ë¯¸ë¦¬ë³´ê¸° + ì¤‘ì§€)")
root.geometry("1000x650")
root.resizable(True, True)

# ---- íƒìƒ‰ ê²½ë¡œ ----
tk.Label(root, text="ğŸ“‚ íƒìƒ‰ ê²½ë¡œ:", anchor="w").pack(fill="x", padx=10, pady=(10, 0))
frame_path = tk.Frame(root)
frame_path.pack(fill="x", padx=10)
entry_path = tk.Entry(frame_path)
entry_path.pack(side="left", fill="x", expand=True, padx=(0, 5))
tk.Button(frame_path, text="í´ë” ì„ íƒ", command=browse_directory).pack(side="right")

# ---- ì •ê·œí‘œí˜„ì‹ ì…ë ¥ ----
tk.Label(root, text="ğŸ§© ì •ê·œí‘œí˜„ì‹ ì…ë ¥:", anchor="w").pack(fill="x", padx=10, pady=(10, 0))
entry_regex = tk.Entry(root)
entry_regex.pack(fill="x", padx=10, pady=(0, 5))
entry_regex.insert(0, r"(['\"])(operator|system|config)\1")

# ---- ì˜µì…˜ ----
var_ignore = tk.BooleanVar(value=False)
tk.Checkbutton(root, text="ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ê²€ìƒ‰", variable=var_ignore).pack(anchor="w", padx=15, pady=5)

# ---- ì§„í–‰ë¥  ë°” ----
progress_var = tk.IntVar()
progress_bar = ttk.Progressbar(root, variable=progress_var, maximum=100)
progress_bar.pack(fill="x", padx=10, pady=(5,5))

# ---- ì‹¤í–‰/ì¤‘ì§€/ì €ì¥ ë²„íŠ¼ ----
frame_buttons = tk.Frame(root)
frame_buttons.pack(fill="x", padx=10, pady=(0, 10))
btn_search = tk.Button(frame_buttons, text="ğŸ” ê²€ìƒ‰ ì‹œì‘", command=start_search, bg="#0078D7", fg="white")
btn_search.pack(side="left", fill="x", expand=True, padx=(0,5))
btn_stop = tk.Button(frame_buttons, text="â¹ ì¤‘ì§€", command=stop_search, bg="#DC3545", fg="white", state="disabled")
btn_stop.pack(side="left", fill="x", expand=True, padx=(0,5))
btn_save = tk.Button(frame_buttons, text="ğŸ’¾ ì—‘ì…€ ì €ì¥", command=save_to_excel, bg="#28A745", fg="white")
btn_save.pack(side="left", fill="x", expand=True, padx=(0,0))

# ---- ê²°ê³¼ í…Œì´ë¸” ----
columns = ("íŒŒì¼ëª…", "ê²€ìƒ‰í‚¤ì›Œë“œ", "ë¼ì¸", "ë‚´ìš©", "ì „ì²´ê²½ë¡œ")
tree = ttk.Treeview(root, columns=columns, show="headings", height=20)
for col in columns:
    tree.heading(col, text=col)
    tree.column(col, width=150 if col != "ë‚´ìš©" else 400, anchor="w")

scrollbar_y = ttk.Scrollbar(root, orient="vertical", command=tree.yview)
tree.configure(yscroll=scrollbar_y.set)
scrollbar_y.pack(side="right", fill="y")
tree.pack(fill="both", expand=True, padx=10, pady=(0,10))

tk.Label(root, text="â€» ê²€ìƒ‰ í™•ì¥ì: .java, .cs, .xml", fg="gray").pack(pady=(0,5))

root.mainloop()
